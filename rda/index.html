<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Yakutia RDA map</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=2e0dfe50-db2b-4cc8-aa37-19513d79b915&lang=ru_RU" type="text/javascript"></script>
    <style>
        body {
            margin: 0;
        }
        #map {
            width: 100%;
            height: 100vh;
        }
        #status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 3px;
            z-index: 1000;
            font-family: Arial;
        }
        .legend {
            position: absolute;
            bottom: 30px;
            right: 3px;
            /*right: calc(50% + 3px);*/
            background: white;
            padding: 10px;
            border-radius: 3px;
            z-index: 1000;
            font-family: Arial;
            font-size: 14px;
        }
        .legend h3 {
            margin: 0;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border: 1px solid #000;
        }
        .ymaps-2-1-79-gototech,
        .ymaps-2-1-79-gotoymaps__container {
            display: none !important;
        }
        .polygon-label {
            font-family: Arial;
            font-size: 12px;
            font-weight: bold;
            color: #000;
            text-shadow: 0 0 3px #fff, 0 0 3px #fff, 0 0 3px #fff, 0 0 3px #fff;
            text-align: center;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="status">Инициализация карты...</div>
    <div class="legend">
        <h3>Рейтинг RDA</h3>
        <div class="legend-item"><div class="legend-color" style="background: #ffb3b2;"></div> <span>0-20%</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #c4c4fe;"></div> <span>20-40%</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #FBEE59;"></div> <span>40-60%</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #70F359;"></div> <span>60-80%</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #1ec900;"></div> <span>80-100%</span></div>
    </div>
    
    <script>
        ymaps.ready(init);
        
        function init() {
            const map = new ymaps.Map("map", {
                center: [62.0339, 129.733], // Центр Якутии
                zoom: 1,
                controls: ['zoomControl'],
                type: 'yandex#map'
            }, {
                suppressMapOpenBlock: true,
                restrictMapArea: [[55.0, 80.0], [75.0, 190.0]],
                // restrictMapArea: [[55.0, 105.0], [75.0, 164.0]],
                minZoom: 1,
                maxZoom: 9
            });
            
            map.setType('yandex#map'); // обычная карта

            ymaps.layer.storage.add('dark#map', function () {
                const layer = new ymaps.Layer(
                    'https://core-renderer-tiles.maps.yandex.net/tiles?l=map&lang=ru_RU&x=%x&y=%y&z=%z&scale=1&theme=dark'
                );
                layer.getZoomRange = function () {
                    return ymaps.vow.resolve([0, 19]);
                };
                return layer;
            });

            ymaps.mapType.storage.add('dark#map', new ymaps.MapType('Темная карта', ['dark#map']));
            map.setType('dark#map');

            document.getElementById('status').textContent = "Загрузка данных...";
            
            loadGeoJSON('RDA_2025X.json')
                .then(geoJsonData => {
                    document.getElementById('status').textContent = "Обработка данных...";
                    const features = processGeoJSON(geoJsonData);
                    displayFeatures(map, features);
                    document.getElementById('status').textContent = `Загружено ${features.length} объектов`;
                    setTimeout(() => document.getElementById('status').style.display = 'none', 5000);
                })
                .catch(error => {
                    console.error("Ошибка:", error);
                    document.getElementById('status').textContent = "Ошибка: " + error.message;
                    document.getElementById('status').style.backgroundColor = "#ffdddd";
                });

        }
        
        async function loadGeoJSON(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Ошибка HTTP! Статус: ${response.status}`);
            }
            return await response.json();
        }
        
        function processGeoJSON(geoJsonData) {
            if (!geoJsonData || !geoJsonData.features) {
                throw new Error("Неверный формат GeoJSON");
            }
            
            return geoJsonData.features.map(feature => {
                const geometry = normalizeGeometry(feature.geometry);
                if (!geometry) {
                    console.warn("Объект пропущен - неверная геометрия:", feature);
                    return null;
                }
                
                return {
                    geometry: geometry,
                    properties: feature.properties || { name: "Без названия", az_rating: 0 }
                };
            }).filter(feature => feature !== null);
        }
        
        function normalizeGeometry(geometry) {
            if (!geometry || !geometry.coordinates) return null;
            
            const swapCoordinates = (coords) => {
                return coords.map(ring => 
                    ring.map(([lat, lon]) => [lon, lat])
                );
            };
            
            if (geometry.type === "MultiPolygon") {
                if (!geometry.coordinates[0] || !geometry.coordinates[0][0]) return null;
                return {
                    type: "Polygon",
                    coordinates: swapCoordinates(geometry.coordinates[0])
                };
            }
            
            if (geometry.type === "Polygon") {
                if (!geometry.coordinates[0]) return null;
                return {
                    type: "Polygon",
                    coordinates: swapCoordinates(geometry.coordinates)
                };
            }
            
            return null;
        }
        
        function getColorByRating(rating) {
            if (rating === undefined || rating === null) return '#CCCCCC'; // Серый для отсутствующих значений
            
            const numRating = parseFloat(rating);
            if (isNaN(numRating)) return '#CCCCCC';
            
            if (numRating < 20) return '#ffb3b2'; // Красный
            if (numRating < 40) return '#c4c4fe'; // Синий
            if (numRating < 60) return '#FBEE59'; // Желтый
            if (numRating < 80) return '#70F359'; // Светло-зеленый
            return '#1ec900'; // Зеленый
        }
        
        function displayFeatures(map, features) {
            if (!features || features.length === 0) {
                console.error("Нет данных для отображения");
                return;
            }
            
            const objectCollection = new ymaps.GeoObjectCollection();
            
            features.forEach(feature => {
                try {
                    const rating = feature.properties.az_rating*100;
                    const color = getColorByRating(rating);
                    
                    // Создаем полигон
                    const polygon = new ymaps.Polygon(
                        feature.geometry.coordinates,
                        {
                            hintContent: `${feature.properties.rda} | ${feature.properties.name} | Рейтинг RDA: ${rating.toFixed(2) || 'нет данных'}`,
                            balloonContent: createBalloonContent(feature.properties),
                        },
                        {
                            fillColor: color,
                            strokeColor: '#FFFFFF',
                            opacity: 0.7,
                            strokeWidth: 2,
                            fillOpacity: 0.7
                        }
                    );
                    
                    // Добавляем подпись к полигону
                    const label = new ymaps.Placemark(
                        getPolygonCenter(feature.geometry.coordinates),
                        {
                            iconContent: feature.properties.rda || 'Без названия'
                        },
                        {
                            preset: 'islands#blackStretchyIcon',
                            iconColor: color,
                            // Убираем стандартную иконку, оставляем только текст
                            iconLayout: 'default#imageWithContent',
                            iconImageHref: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"></svg>',
                            iconImageSize: [1, 1],
                            iconImageOffset: [0, 0],
                            iconContentOffset: [0, 0],
                            // Стили для текста
                            iconContentLayout: ymaps.templateLayoutFactory.createClass(
                                '<div class="polygon-label" style="color: black; font-size: 12px; font-weight: bold; text-shadow: 0 0 3px white, 0 0 3px white, 0 0 3px white, 0 0 3px white;">$[properties.iconContent]</div>'
                            )
                        }
                    );
                    
                    // Создаем группу для полигона и его подписи
                    const group = new ymaps.GeoObjectCollection();
                    group.add(polygon);
                    group.add(label);
                    
                    objectCollection.add(group);
                } catch (e) {
                    console.error("Ошибка создания полигона:", feature, e);
                }
            });
            
            map.geoObjects.add(objectCollection);
            
            if (objectCollection.getLength() > 0) {
                map.setBounds(objectCollection.getBounds(), {
                    checkZoomRange: true,
                    zoomMargin: 50
                });
            }
        }
        
        // Функция для вычисления центра полигона
        function getPolygonCenter(coordinates) {
            const ring = coordinates[0]; // Берем внешний контур полигона
            let area = 0;
            let latSum = 0;
            let lonSum = 0;
            const n = ring.length - 1; // Игнорируем последнюю точку (она равна первой)
            
            // Алгоритм вычисления центроида для многоугольника
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                const xi = ring[i][0];
                const yi = ring[i][1];
                const xj = ring[j][0];
                const yj = ring[j][1];
                
                const cross = xi * yj - xj * yi;
                latSum += (xi + xj) * cross;
                lonSum += (yi + yj) * cross;
                area += cross;
            }
            
            area = area / 2;
            const centerLat = latSum / (6 * area);
            const centerLon = lonSum / (6 * area);
            
            return [centerLat, centerLon];
        }
        
        function createBalloonContent(properties) {
            let content = `<div style="padding: 5px; font-family: Arial; font-size: 14px;">`;
            content += `<b>${properties.name || 'Без названия'}</b>`;
            
            if (properties.rda) {
                content += `<br><span>Район: <a href="${properties.rda}">${properties.rda}</a></span>`;
            }
            if (properties.az_rating !== undefined && properties.az_rating !== null) {
                properties.az_rating = properties.az_rating * 100;
                properties.az_rating = properties.az_rating.toFixed(2);
                content += `<br><span>Рейтинг RDA: ${properties.az_rating}%</span>`;
            }
            
            content += `</div>`;
            return content;
        }

    </script>
</body>
</html>