<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Отображение полигонов на Яндекс Карте</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=2e0dfe50-db2b-4cc8-aa37-19513d79b915&lang=ru_RU" type="text/javascript"></script>
    <style>
        #map {
            width: 100%;
            height: 800px;
        }
        #status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
            font-family: Arial;
        }
        .legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
            font-family: Arial;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border: 1px solid #000;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="status">Инициализация карты...</div>
    <div class="legend">
        <h3>Легенда (az_rating)</h3>
        <div class="legend-item"><div class="legend-color" style="background: #FF0000;"></div> <span>< 0.20</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #0000FF;"></div> <span>0.20 - 0.40</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #FFFF00;"></div> <span>0.40 - 0.60</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #90EE90;"></div> <span>0.60 - 0.80</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #008000;"></div> <span>> 0.80</span></div>
    </div>
    
    <script>
        ymaps.ready(init);
        
        function init() {
            const map = new ymaps.Map("map", {
                center: [62.0, 130.0],
                zoom: 5
            });
            
            document.getElementById('status').textContent = "Загрузка данных...";
            
            loadGeoJSON('RDA_2025X.json')
                .then(geoJsonData => {
                    document.getElementById('status').textContent = "Обработка данных...";
                    const features = processGeoJSON(geoJsonData);
                    displayFeatures(map, features);
                    document.getElementById('status').textContent = `Загружено ${features.length} объектов`;
                    setTimeout(() => document.getElementById('status').style.display = 'none', 5000);
                })
                .catch(error => {
                    console.error("Ошибка:", error);
                    document.getElementById('status').textContent = "Ошибка: " + error.message;
                    document.getElementById('status').style.backgroundColor = "#ffdddd";
                });
        }
        
        async function loadGeoJSON(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Ошибка HTTP! Статус: ${response.status}`);
            }
            return await response.json();
        }
        
        function processGeoJSON(geoJsonData) {
            if (!geoJsonData || !geoJsonData.features) {
                throw new Error("Неверный формат GeoJSON");
            }
            
            return geoJsonData.features.map(feature => {
                const geometry = normalizeGeometry(feature.geometry);
                if (!geometry) {
                    console.warn("Объект пропущен - неверная геометрия:", feature);
                    return null;
                }
                
                return {
                    geometry: geometry,
                    properties: feature.properties || { name: "Без названия", az_rating: 0 }
                };
            }).filter(feature => feature !== null);
        }
        
        function normalizeGeometry(geometry) {
            if (!geometry || !geometry.coordinates) return null;
            
            const swapCoordinates = (coords) => {
                return coords.map(ring => 
                    ring.map(([lat, lon]) => [lon, lat])
                );
            };
            
            if (geometry.type === "MultiPolygon") {
                if (!geometry.coordinates[0] || !geometry.coordinates[0][0]) return null;
                return {
                    type: "Polygon",
                    coordinates: swapCoordinates(geometry.coordinates[0])
                };
            }
            
            if (geometry.type === "Polygon") {
                if (!geometry.coordinates[0]) return null;
                return {
                    type: "Polygon",
                    coordinates: swapCoordinates(geometry.coordinates)
                };
            }
            
            return null;
        }
        
        function getColorByRating(rating) {
            if (rating === undefined || rating === null) return '#CCCCCC'; // Серый для отсутствующих значений
            
            const numRating = parseFloat(rating);
            if (isNaN(numRating)) return '#CCCCCC';
            
            if (numRating < 0.20) return '#FF0000'; // Красный
            if (numRating < 0.40) return '#0000FF'; // Синий
            if (numRating < 0.60) return '#FFFF00'; // Желтый
            if (numRating < 0.80) return '#90EE90'; // Светло-зеленый
            return '#008000'; // Зеленый
        }
        
        function displayFeatures(map, features) {
            if (!features || features.length === 0) {
                console.error("Нет данных для отображения");
                return;
            }
            
            const objectCollection = new ymaps.GeoObjectCollection();
            
            features.forEach(feature => {
                try {
                    const rating = feature.properties.az_rating;
                    const color = getColorByRating(rating);
                    
                    const polygon = new ymaps.Polygon(
                        feature.geometry.coordinates,
                        {
                            hintContent: `${feature.properties.name} (az_rating: ${rating || 'нет данных'})`,
                            balloonContent: createBalloonContent(feature.properties),
                        },
                        {
                            fillColor: color,
                            strokeColor: '#000000',
                            opacity: 0.8,
                            strokeWidth: 1,
                            fillOpacity: 0.7
                        }
                    );
                    
                    objectCollection.add(polygon);
                } catch (e) {
                    console.error("Ошибка создания полигона:", feature, e);
                }
            });
            
            map.geoObjects.add(objectCollection);
            
            if (objectCollection.getLength() > 0) {
                map.setBounds(objectCollection.getBounds(), {
                    checkZoomRange: true,
                    zoomMargin: 50
                });
            }
        }
        
        function createBalloonContent(properties) {
            let content = `<div style="padding: 5px; font-family: Arial; font-size: 14px;">`;
            content += `<b>${properties.name || 'Без названия'}</b>`;
            
            if (properties.az_rating !== undefined && properties.az_rating !== null) {
                content += `<br><span>Рейтинг: ${properties.az_rating}</span>`;
            }
            if (properties.rda) {
                content += `<br><span>Район: ${properties.rda}</span>`;
            }
            if (properties.osm_id) {
                content += `<br><span>OSM ID: ${properties.osm_id}</span>`;
            }
            
            content += `</div>`;
            return content;
        }
    </script>
</body>
</html>