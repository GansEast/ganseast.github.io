<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>RDA: Республика Саха</title>
  <!-- Подключаем API с несколькими fallback-источниками -->
  <script>
    function loadYandexMaps() {
      return new Promise((resolve, reject) => {
        // Основной источник
        const primaryScript = document.createElement('script');
        primaryScript.src = 'https://api-maps.yandex.ru/3.0/?apikey=2e0dfe50-db2b-4cc8-aa37-19513d79b915&lang=ru_RU';
        primaryScript.onload = resolve;
        primaryScript.onerror = () => {
          // Первый fallback
          const fallback1 = document.createElement('script');
          fallback1.src = 'https://api-maps.yandex.ru/2.1/?apikey=2e0dfe50-db2b-4cc8-aa37-19513d79b915&lang=ru_RU';
          fallback1.onload = resolve;
          fallback1.onerror = () => {
            // Второй fallback - используем Leaflet
            loadLeaflet().then(resolve).catch(reject);
          };
          document.head.appendChild(fallback1);
        };
        document.head.appendChild(primaryScript);
      });
    }

    function loadLeaflet() {
      return new Promise((resolve, reject) => {
        // Подключаем Leaflet как альтернативу
        const leafletCss = document.createElement('link');
        leafletCss.rel = 'stylesheet';
        leafletCss.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
        
        const leafletScript = document.createElement('script');
        leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
        leafletScript.onload = resolve;
        leafletScript.onerror = reject;
        
        document.head.appendChild(leafletCss);
        document.head.appendChild(leafletScript);
      });
    }
  </script>
  <style>
    html, body, #map {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 5px;
      font-family: Arial;
      max-width: 80%;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="status">Инициализация карты...</div>

  <script>
    // Конфигурация
    const CONFIG = {
      initialCenter: [63.5, 129.8],
      initialZoom: 4,
      wfsUrl: "https://map.r1cf.ru/geoserver/cite/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=RDA_2025X&outputFormat=application/json&CQL_FILTER=rda%20LIKE%20'YA%25'"
    };

    // Главная функция инициализации
    async function init() {
      try {
        updateStatus("Загрузка картографического API...");
        
        // Пытаемся загрузить Яндекс.Карты или Leaflet
        await loadYandexMaps();
        
        // Проверяем, какой API загрузился
        if (window.ymaps) {
          initYandexMap();
        } else if (window.L) {
          initLeafletMap();
        } else {
          throw new Error("Не удалось загрузить ни один картографический API");
        }
        
      } catch (error) {
        updateStatus("Ошибка: " + error.message);
        console.error("Ошибка инициализации:", error);
      }
    }

    // Инициализация Яндекс.Карт
    function initYandexMap() {
      updateStatus("Инициализация Яндекс.Карт...");
      
      ymaps.ready(() => {
        const map = new ymaps.Map("map", {
          center: CONFIG.initialCenter,
          zoom: CONFIG.initialZoom,
          controls: ['zoomControl']
        });

        loadAndDisplayData(map, (map, geojson) => {
          const objectManager = new ymaps.ObjectManager({
            clusterize: true,
            gridSize: 32,
            clusterDisableClickZoom: true
          });
          
          objectManager.objects.options.set('preset', 'islands#redDotIcon');
          objectManager.clusters.options.set('preset', 'islands#redClusterIcons');
          
          objectManager.add(filterPointsOnly(geojson));
          map.geoObjects.add(objectManager);
        });
      });
    }

    // Инициализация Leaflet
    function initLeafletMap() {
      updateStatus("Инициализация Leaflet...");
      
      const map = L.map('map').setView(CONFIG.initialCenter, CONFIG.initialZoom);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);
      
      loadAndDisplayData(map, (map, geojson) => {
        L.geoJSON(filterPointsOnly(geojson), {
          pointToLayer: (feature, latlng) => L.marker(latlng),
          style: { color: 'red' }
        }).addTo(map);
      });
    }

    // Загрузка и отображение данных (универсальная функция)
    async function loadAndDisplayData(map, displayCallback) {
      try {
        updateStatus("Загрузка данных...");
        const response = await fetch(CONFIG.wfsUrl);
        const geojson = await response.json();
        
        updateStatus(`Загружено объектов: ${geojson.features.length}`);
        
        // Отображение данных (только точек)
        displayCallback(map, geojson);
        
      } catch (error) {
        console.error("Ошибка загрузки данных:", error);
        updateStatus("Ошибка загрузки данных. Используем тестовые данные");
        displayTestData(map, displayCallback);
      }
    }

    // Фильтрация только точек
    function filterPointsOnly(geojson) {
      if (!geojson || !geojson.features) return { type: "FeatureCollection", features: [] };
      
      return {
        type: "FeatureCollection",
        features: geojson.features.filter(
          feature => feature.geometry && feature.geometry.type === "Point"
        )
      };
    }

    // Показать тестовые данные
    function displayTestData(map, displayCallback) {
      const testData = {
        type: "FeatureCollection",
        features: [
          createTestFeature("Якутск", [129.73, 62.03], "YA_TEST_001"),
          createTestFeature("Мирный", [113.96, 62.53], "YA_TEST_002")
        ]
      };
      
      displayCallback(map, testData);
    }

    function createTestFeature(name, coords, rda) {
      return {
        type: "Feature",
        properties: { name, rda },
        geometry: { 
          type: "Point", 
          coordinates: coords 
        }
      };
    }

    function updateStatus(message) {
      document.getElementById("status").textContent = message;
    }

    // Запуск приложения
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>